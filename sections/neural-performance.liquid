<section id='why-it-works' class='section-padding bg-dark relative'>
  <div class='absolute inset-0 bg-neuron-pattern opacity-5'></div>
  <div class='container-custom relative'>
    {% render 'section-title' %}

    <div class='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4'>
      {% for block in section.blocks %}
        {% assign trimmed_title = block.settings.card_title | handleize %}

        <button
          data-neural-card='{{ trimmed_title }}'
          class='feature-card group hover:shadow-glow fade-in text-left is-visible style-VktoH'
          id='action-{{ trimmed_title }}'
        >
          <div class='mb-4'>
            <img
              class='h-full'
              alt='Neural Pathways Card Icon'
              src='{{ block.settings.card_icon | image_url }}'
            >
          </div>
          <h4 class='text-white text-lg font-semibold mb-2 group-hover:text-primary transition-colors'>
            {{ block.settings.card_title }}
          </h4>
          <p class='text-light mb-4'>{{ block.settings.card_subtitle }}</p>
          <div class='flex items-center text-sm'>
            <div class='h-2 w-2 rounded-full bg-primary mr-2'></div>
            <span class='text-primary'>{{ block.settings.accent_bullet }}</span>
          </div>
          <div class='mt-4 h-1 w-0 bg-primary group-hover:w-full transition-all duration-500'></div>
        </button>

        <div
          data-neural-card='{{ trimmed_title }}'
          id='modal-{{ trimmed_title }}'
          class='feature-modal fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50'
        >
          <div
            id='feature-modal'
            class='bg-darker rounded-lg overflow-hidden relative w-full max-w-[900px] md:w-3/4 h-auto max-h-[90vh] flex flex-col'
          >
            <button
              id='feature-modal-close'
              class='absolute top-4 right-4 w-[50px] h-[50px] text-black text-2xl font-bold hover:text-gray-600 text-primary'
            >
              &times;
            </button>

            <div class='w-full h-[200px] md:h-[256px] bg-gray-200 overflow-hidden'>
              <img
                id='feature-modal-image'
                class='w-full h-full object-cover'
                alt='Feature image'
                src='{{ block.settings.modal_image | image_url }}'
              >
            </div>

            <div id='feature-modal-content' class='p-8 overflow-y-auto'>
              <h3 id='feature-modal-title' class='text-3xl font-bold text-white mb-2'>
                {{ block.settings.modal_title }}
              </h3>
              <h4 id='feature-modal-subtitle' class='text-primary text-lg mb-6'>{{ block.settings.modal_subtitle }}</h4>

              <div>
                <h3 id='feature-modal-descTitle' class='text-white text-xl font-semibold mb-4'>
                  {{ block.settings.modal_secondary_text }}
                </h3>
                <p id='feature-modal-descContent' class='text-light'>{{ block.settings.modal_description }}</p>
              </div>
              <div>
                <h3 id='feature-modal-bulletsTitle' class='text-white text-xl font-semibold mt-4 mb-4'>Key Benefits</h3>
                <ul
                  id='feature-modal-description'
                  class='text-gray-700 mb-4 grid grid-cols-1 md:grid-cols-2 gap-4'
                >
                  {% assign benefits_string = block.settings.key_benefits | default: '' %}
                  {% assign split_benefits = benefits_string | split: ',' %}

                  {% for benefit in split_benefits %}
                    {% assign item = benefit | strip %}

                    {% if item != '' %}
                      <li class='flex items-start'>
                        <div class='h-2 w-2 rounded-full bg-primary mt-2 mr-2 flex-shrink-0'></div>
                        <span class='text-light'>{{ item }}</span>
                      </li>
                    {% endif %}
                  {% endfor %}
                </ul>
              </div>
              {% if block.settings.science_content != blank %}
                <div>
                  <button
                    href='{{ block.settings.science_link}}'
                    type='submit'
                    class='expand-mm-research-inner w-full mt-6 text-center btn btn-mint px-8 py-4 text-lg font-bold hover:transform hover:scale-105 transition-transform'
                  >
                    View Science
                  </button>
                  <div class='mm-research-inner'>
                    {% if block.settings.science_intro != blank %}
                      <p class='mm-research-intro'>{{ block.settings.science_intro }}</p>
                    {% endif %}
                    {% if block.settings.science_content != blank %}
                      <div class='research-content-well'>
                        {{ block.settings.science_content }}
                      </div>
                    {% endif %}
                    <!--
                      <p class='mm-research-intro'>
                        Over 500 peer-reviewed studies document Rhodiola's cognitive and stress-reducing effects.
                      </p>
                      <div class='mm-study-item'>
                        <div class='mm-study-authors'>Anghelescu et al., 2018</div>
                        <div class='mm-study-finding'>
                          Rhodiola extract improves mental performance in people with stress-related fatigue.
                        </div>
                        <a
                          href='https://www.tandfonline.com/doi/full/10.1080/13651501.2017.1417442'
                          target='_blank'
                          class='mm-study-link'
                          >View Full Study →</a
                        >
                      </div>
                    -->
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</section>

<style>
  .mm-research-inner {
    height: 0;
    overflow: hidden;
    transition: height 0.35s ease;
    margin-top: 1.5rem;
  }

  .mm-research-inner.is-open {
    /* no height here; JS sets height */
  }

  /* .mm-research-inner .research-content-well h1,
  .mm-research-inner .research-content-well h2,
  .mm-research-inner .research-content-well h3,
  .mm-research-inner .research-content-well h4,
  .mm-research-inner .research-content-well h5,
  .mm-research-inner .research-content-well h6 {
    font-size: 1.5rem;
    color: #00e5a0;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .mm-research-inner .research-content-well p {
    margin-bottom: 1rem;
    font-weight: 600;
  }

  .mm-research-inner .research-content-well p a {
    color: #00e5a0;
    text-decoration: none;
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 2.5rem;
  } */

  .mm-research-inner .research-content-well {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .mm-research-inner .research-content-well ul {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding-left: 1rem;
    border-left: 2px solid #00e5a0;
  }

  .mm-research-inner .research-content-well {
    margin: 1.25rem 0;
  }

  .mm-research-inner .research-content-well ul li:first-child {
    font-size: 1.25rem;
    color: #00e5a0;
    font-weight: 600;
  }

  .mm-research-inner .research-content-well ul li:last-child a,
  .mm-research-inner .research-content-well ul li:last-child p a {
    color: #00e5a0;
    text-decoration: none;
    font-size: 1rem;
    font-weight: 600;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const cards = document.querySelectorAll('.feature-card');
    const modals = document.querySelectorAll('.feature-modal');

    function collapseResearch(modalEl) {
      if (!modalEl) return;
      const inner = modalEl.querySelector('.mm-research-inner');
      if (!inner) return;

      inner.classList.remove('is-open');
      inner.style.height = '0px';
    }

    function expandResearch(modalEl) {
      if (!modalEl) return;
      const inner = modalEl.querySelector('.mm-research-inner');
      if (!inner) return;

      // Set to its natural content height for a smooth open animation
      inner.classList.add('is-open');
      inner.style.height = inner.scrollHeight + 'px';
    }

    function toggleModal(modalKey) {
      if (!modalKey) return;
      const modal = document.getElementById(`modal-${modalKey}`);
      if (!modal) return;

      const isOpening = modal.classList.contains('hidden');

      if (isOpening) {
        modal.classList.remove('hidden');
        modal.classList.add('flex', 'current-modal');

        // Ensure research starts collapsed every time modal opens
        collapseResearch(modal);
      } else {
        // Reset research when closing
        collapseResearch(modal);

        modal.classList.add('hidden');
        modal.classList.remove('flex', 'current-modal');
      }
    }

    // Open modal from card click
    cards.forEach((card) => {
      card.addEventListener('click', () => {
        const cardKey = (card.dataset.neuralCard || '').trim();
        if (!cardKey) return;
        toggleModal(cardKey);
      });
    });

    // Close modal (click backdrop or X)
    modals.forEach((modal) => {
      modal.addEventListener('click', (e) => {
        const modalKey = (modal.dataset.neuralCard || '').trim();
        if (!modalKey) return;

        if (e.target.closest('#feature-modal-close')) {
          toggleModal(modalKey);
          return;
        }

        // Clicked inside the modal content → do nothing
        if (e.target.closest('#feature-modal')) return;

        // Clicked backdrop → close
        toggleModal(modalKey);
      });
    });

    // Expand science in the currently open modal
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.expand-mm-research-inner');
      if (!btn) return;

      e.preventDefault();

      const modal = btn.closest('.feature-modal');
      if (!modal) return;

      const inner = modal.querySelector('.mm-research-inner');
      if (!inner) return;

      const isOpen = inner.classList.contains('is-open');

      if (isOpen) {
        // Collapse
        collapseResearch(modal);
      } else {
        // Expand
        expandResearch(modal);

        // Optional: keep height correct if content loads images and changes size
        // (runs once shortly after expanding)
        setTimeout(() => {
          if (inner.classList.contains('is-open')) {
            inner.style.height = inner.scrollHeight + 'px';
          }
        }, 150);
      }
    });

    // Escape closes current modal and resets science panel
    document.addEventListener('keydown', (e) => {
      if (e.key !== 'Escape') return;

      const modal = document.querySelector('.feature-modal.current-modal');
      if (!modal) return;

      const modalKey = (modal.dataset.neuralCard || '').trim();
      if (!modalKey) return;

      toggleModal(modalKey);
    });
  });
</script>

{% schema %}
{
  "name": "Neural Cards",
  "settings": [
    {
      "type": "text",
      "id": "section_title",
      "label": "Section title",
      "default": "NEURAL PATHWAYS, ACTIVATED",
      "info": "Separate title with comma to split white & green text/new line"
    },
    {
      "type": "text",
      "id": "section_subtitle",
      "label": "Section subtitle",
      "default": "Science-backed formula designed for cognitive enhancement"
    }
  ],
  "max_blocks": 5,
  "blocks": [
    {
      "type": "section_card",
      "name": "Section Card",
      "settings": [
        {
          "type": "image_picker",
          "id": "card_icon",
          "label": "Card Icon"
        },
        {
          "type": "text",
          "id": "card_title",
          "label": "Card Title"
        },
        {
          "type": "text",
          "id": "card_subtitle",
          "label": "Card Subtitle"
        },
        {
          "type": "text",
          "id": "accent_bullet",
          "label": "Accent Bulletpoint"
        },
        {
          "type": "image_picker",
          "id": "modal_image",
          "label": "Modal Image"
        },
        {
          "type": "text",
          "id": "modal_title",
          "label": "Modal Title"
        },
        {
          "type": "text",
          "id": "modal_subtitle",
          "label": "Modal Subtitle"
        },
        {
          "type": "text",
          "id": "modal_secondary_text",
          "label": "Modal Secondary Text"
        },
        {
          "type": "text",
          "id": "modal_description",
          "label": "Modal Description"
        },
        {
          "type": "text",
          "id": "key_benefits",
          "label": "Key Benefits",
          "info": "Separate each key benefit by a comma"
        },
        {
          "type": "text",
          "id": "science_intro",
          "label": "Intro for Science"
        },
        {
          "type": "richtext",
          "id": "science_content",
          "label": "Content for Science"
        }
      ]
    }
  ]
}
{% endschema %}
