{% comment %}
  Social Proof Testimonials (Carousel)
  - Blocks: testimonials
  - CSS in assets/social-proof-testimonials.css
{% endcomment %}

{{ 'social-proof-testimonials.css' | asset_url | stylesheet_tag }}

{% liquid
  assign sid = section.id
  assign block_count = section.blocks.size
%}

<section class='social-proof-section' data-social-proof data-section-id='{{ sid }}'>
  <div class='social-proof-header'>
    {% if section.settings.eyebrow != blank %}
      <div class='social-proof-eyebrow'>{{ section.settings.eyebrow }}</div>
    {% endif %}
    {% if section.settings.title != blank %}
      <h2 class='social-proof-title'>{{ section.settings.title }}</h2>
    {% endif %}
    {% if section.settings.subtitle != blank %}
      <p class='social-proof-subtitle'>{{ section.settings.subtitle }}</p>
    {% endif %}
  </div>

  {% if block_count > 0 %}
    <div class='carousel-container'>
      <div class='carousel-wrapper'>
        <div
          class='carousel-track'
          data-carousel-track
          aria-roledescription='carousel'
          aria-label='Testimonials'
        >
          {% for block in section.blocks %}
            {% assign initial = block.settings.name | default: 'A' | slice: 0, 1 %}
            {% assign stars = block.settings.stars | default: 5 %}

            <div class='testimonial-slide' {{ block.shopify_attributes }}>
              <div class='testimonial-card'>
                <div class='testimonial-stars' aria-label='{{ stars }} out of 5 stars'>
                  {% for i in (1..stars) -%}
                    â˜…
                  {%- endfor %}
                </div>

                {% if block.settings.quote != blank %}
                  <p class='testimonial-text'>
                    {{ block.settings.quote }}
                  </p>
                {% endif %}

                <div class='testimonial-author'>
                  {% if block.settings.avatar != blank %}
                    <div class='author-avatar author-avatar--image'>
                      {{
                        block.settings.avatar
                        | image_url: width: 96
                        | image_tag: alt: block.settings.name, loading: 'lazy'
                      }}
                    </div>
                  {% else %}
                    <div class='author-avatar' aria-hidden='true'>{{ initial | upcase }}</div>
                  {% endif %}

                  <div class='author-info'>
                    {% if block.settings.name != blank %}
                      <div class='author-name'>{{ block.settings.name }}</div>
                    {% endif %}
                    {% if block.settings.role != blank %}
                      <div class='author-role'>{{ block.settings.role }}</div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      {% if section.settings.show_dots %}
        <div class='carousel-dots' data-carousel-dots>
          {% for block in section.blocks %}
            <button
              class='dot{% if forloop.first %} active{% endif %}'
              type='button'
              aria-label='Go to testimonial {{ forloop.index }}'
              aria-current='{% if forloop.first %}true{% else %}false{% endif %}'
              data-index='{{ forloop.index0 }}'
            ></button>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  {% endif %}
</section>

<script>
  (() => {
    const sectionEl = document.querySelector('[data-social-proof][data-section-id="{{ sid }}"]');
    if (!sectionEl) return;

    const track = sectionEl.querySelector('[data-carousel-track]');
    const dotsContainer = sectionEl.querySelector('[data-carousel-dots]');
    const dots = dotsContainer ? Array.from(dotsContainer.querySelectorAll('[data-index]')) : [];
    const totalSlides = track ? track.children.length : 0;

    if (!track || totalSlides <= 1) return;

    let currentIndex = 0;
    let startX = 0;
    let currentX = 0;
    let isDragging = false;
    let autoPlayInterval = null;

    const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    // const autoplayEnabled = {{ section.settings.autoplay | json }} && !prefersReducedMotion;
    // const autoplayMs = Number({{ section.settings.autoplay_interval | json }}) || 5000;
    const autoplayEnabled = true;
    const autoplayMs = 5000;

    function setDots() {
      dots.forEach((dot, i) => {
        const active = i === currentIndex;
        dot.classList.toggle('active', active);
        dot.setAttribute('aria-current', active ? 'true' : 'false');
      });
    }

    function goToSlide(index, smooth = true) {
      currentIndex = Math.max(0, Math.min(index, totalSlides - 1));
      track.classList.toggle('no-transition', !smooth);

      const offset = -currentIndex * 100;
      track.style.transform = `translateX(${offset}%)`;

      setDots();
    }

    function nextSlide() {
      goToSlide((currentIndex + 1) % totalSlides);
    }
    function prevSlide() {
      goToSlide((currentIndex - 1 + totalSlides) % totalSlides);
    }

    function startAutoPlay() {
      stopAutoPlay();
      if (!autoplayEnabled) return;
      autoPlayInterval = window.setInterval(nextSlide, autoplayMs);
    }

    function stopAutoPlay() {
      if (autoPlayInterval) window.clearInterval(autoPlayInterval);
      autoPlayInterval = null;
    }

    // Touch events
    track.addEventListener(
      'touchstart',
      (e) => {
        isDragging = true;
        startX = e.touches[0].clientX;
        currentX = startX;
        stopAutoPlay();
      },
      { passive: true }
    );

    track.addEventListener(
      'touchmove',
      (e) => {
        if (!isDragging) return;
        currentX = e.touches[0].clientX;
        const diff = currentX - startX;

        const offset = -currentIndex * 100 + (diff / track.offsetWidth) * 100;
        track.classList.add('no-transition');
        track.style.transform = `translateX(${offset}%)`;
      },
      { passive: true }
    );

    track.addEventListener('touchend', () => {
      if (!isDragging) return;
      isDragging = false;

      const diff = currentX - startX;
      const threshold = track.offsetWidth * 0.25;

      if (Math.abs(diff) > threshold) diff > 0 ? prevSlide() : nextSlide();
      else goToSlide(currentIndex);

      startAutoPlay();
    });

    // Mouse drag
    track.addEventListener('mousedown', (e) => {
      isDragging = true;
      startX = e.clientX;
      currentX = startX;
      stopAutoPlay();
      e.preventDefault();
    });

    track.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      currentX = e.clientX;
      const diff = currentX - startX;

      const offset = -currentIndex * 100 + (diff / track.offsetWidth) * 100;
      track.classList.add('no-transition');
      track.style.transform = `translateX(${offset}%)`;
    });

    function endMouseDrag() {
      if (!isDragging) return;
      isDragging = false;

      const diff = currentX - startX;
      const threshold = track.offsetWidth * 0.25;

      if (Math.abs(diff) > threshold) diff > 0 ? prevSlide() : nextSlide();
      else goToSlide(currentIndex);

      startAutoPlay();
    }

    track.addEventListener('mouseup', endMouseDrag);
    track.addEventListener('mouseleave', () => {
      if (isDragging) {
        isDragging = false;
        goToSlide(currentIndex);
        startAutoPlay();
      }
    });

    // Dots click
    dots.forEach((dot) => {
      dot.addEventListener('click', () => {
        const idx = Number(dot.getAttribute('data-index'));
        if (Number.isNaN(idx)) return;
        stopAutoPlay();
        goToSlide(idx);
        startAutoPlay();
      });
    });

    // Init
    goToSlide(0, false);
    startAutoPlay();

    // Stop autoplay when section is out of view (nice for performance)
    const io = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (!autoplayEnabled) return;
          if (entry.isIntersecting) startAutoPlay();
          else stopAutoPlay();
        });
      },
      { threshold: 0.25 }
    );

    io.observe(sectionEl);

    // Theme editor: re-init on block changes
    document.addEventListener('shopify:section:unload', (e) => {
      if (e.detail.sectionId === '{{ sid }}') {
        stopAutoPlay();
        io.disconnect();
      }
    });
  })();
</script>

{% schema %}
{
  "name": "Testimonials",
  "tag": "section",
  "class": "section-testimonials",
  "settings": [
    {
      "type": "text",
      "id": "eyebrow",
      "label": "Eyebrow",
      "default": "REAL RESULTS FROM REAL PEOPLE"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Heading",
      "default": "10,000+ High Performers Trust MindMix"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subheading",
      "default": "Tap to read reviews"
    },
    {
      "type": "checkbox",
      "id": "show_dots",
      "label": "Show dots",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Autoplay",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_interval",
      "label": "Autoplay interval (ms)",
      "min": 2000,
      "max": 9000,
      "step": 500,
      "default": 5000
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        {
          "type": "range",
          "id": "stars",
          "label": "Stars",
          "min": 1,
          "max": 5,
          "step": 1,
          "default": 5
        },
        {
          "type": "textarea",
          "id": "quote",
          "label": "Quote",
          "default": "This is the real deal. Clean focus, no crash."
        },
        {
          "type": "text",
          "id": "name",
          "label": "Name",
          "default": "Alex Chen"
        },
        {
          "type": "text",
          "id": "role",
          "label": "Role / Title",
          "default": "Software Engineer"
        },
        {
          "type": "image_picker",
          "id": "avatar",
          "label": "Avatar (optional)"
        }
      ]
    }
  ],
  "max_blocks": 20,
  "presets": [
    {
      "name": "Social proof - Testimonials",
      "blocks": [{ "type": "testimonial" }, { "type": "testimonial" }, { "type": "testimonial" }]
    }
  ]
}
{% endschema %}
