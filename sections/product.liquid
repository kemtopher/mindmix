<section
  id='shopify-section-main-product'
  class='w-full pt-44 pb-16 flex flex-col md:flex-row items-center justify-center'
>
  <div class='container flex flex-col md:flex-row justify-between gap-8'>
    <div class='product-gallery w-full flex flex-col lg:flex-row gap-4 lg:gap-8 justify-start'>
      <!--
        {%- assign image_media = product.media | where: 'media_type', 'image' -%}
        {% if image_media.size > 0 %}
      -->
      <div class='product-images scrollbar-hide overflow-x-scroll overflow-y-hidden w-full flex flex-row md:flex-col gap-4 order-2 lg:order-1 justify-start'>
        {% for media in product.media %}
          {% if media.media_type == 'image' %}
            <div class='product-image relative aspect-square w-[72px] h-[72px]'>
              <img
                src='{{ media | img_url: '72x72' }}'
                data-full='{{ media | img_url: 'master' }}'
                alt='{{ media.alt | escape | default: product.title }}'
                class='thumb cursor-pointer w-full object-contain object-center transition hover:opacity-80'
                loading='{% if forloop.first %}eager{% else %}lazy{% endif %}'
              >
            </div>
          {% endif %}
        {% endfor %}
      </div>
      <!-- {% endif %} -->

      <div class='order-1 lg:order-2 text-center aspect-w-4 aspect-h-6'>
        <img
          id='main-product-image'
          src='{{ product.featured_image | img_url: 'master' }}'
          alt='{{ product.title }}'
          class='h-full w-full object-cover transition-opacity duration-500'
        >
      </div>
    </div>

    <div class='product-details w-full'>
      <!-- product info block -->
      <div class='product-info pb-8'>
        <h1 class='text-2xl lg:text-4xl font-bold text-primary mb-4'>{{ product.title | upcase }}</h1>
        <div class='text-sm text-white h-max mb-4 font-light'>{{ product.description }}</div>

        {% assign current_variant = product.selected_or_first_available_variant %}

        <div
          id='variant-price'
          class='text-2xl lg:text-3xl text-primary {% unless current_variant.available %}out-of-stock{% endunless %}'
        >
          {% if current_variant.price == 0 %}
            Free - just pay shipping
          {% else %}
            {{ current_variant.price | money }}
          {% endif %}
        </div>
        <!--
          <div id='variant-price' class='text-2xl lg:text-3xl text-primary'>{{ product.selected_or_first_available_variant | money }}</div>
        -->
      </div>

      {% if product.handle != 'free-trial-pack' %}
        <div class='product-variant-select'>
          <p class='text-base text-white font-normal'>Quantity:</p>

          {% assign variant_size = product.variants %}
          {% if variant_size.size > 0 %}
            {% assign current_variant = product.selected_or_first_available_variant %}

            <div class='variant-well flex py-4 gap-4 group flex-wrap'>
              {% for variant in product.variants %}
                {% assign is_default = false %}
                {% if current_variant and variant.id == current_variant.id and variant.available %}
                  {% assign is_default = true %}
                {% endif %}

                <div class='variant-option flex flex-col items-start'>
                  <button
                    class='variant-button p-4 border hover:cursor-pointer hover:border-primary hover:text-primary{% if is_default %} active border-primary{% endif %}{% unless variant.available %} opacity-50{% endunless %}'
                    data-variant-id='{{ variant.id }}'
                    data-variant-price='{{ variant.price }}'
                    data-available='{{ variant.available }}'
                    data-default='{% if is_default %}true{% else %}false{% endif %}'
                    onclick='handleVariantClick(event, "{{ variant.id }}", "{{ variant.price | json }}")'
                  >
                    <h3>{{ variant.title }}</h3>
                    <input
                      type='radio'
                      name='variant'
                      id='variant-{{ variant.id }}'
                      value='{{ variant.id }}'
                      hidden
                    >
                  </button>

                  <!--
                    {% unless variant.available %}
                      <p class='mt-1 text-xs text-red-400'>Out of stock</p>
                    {% endunless %}
                  -->
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% endif %}

      {% render 'da-restock' %}

      <div
        id='subscription-wrapper'
        class='mt-4 {% unless current_variant.available %}hidden{% endunless %}'
      >
        <div class='subscriptions_app_embed_block mt-4'></div>
      </div>

      {% render 'add-to-cart-btn' %}

      {% unless product.handle == 'free-trial-pack' %}
        {% render 'free-trial-btn' %}
      {% endunless %}
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // product variant image resetting
    const mainImage = document.getElementById('main-product-image');
    const thumbs = document.querySelectorAll('.thumb');

    thumbs.forEach((thumb) => {
      thumb.addEventListener('click', () => {
        const newSrc = thumb.getAttribute('data-full');
        const newAlt = thumb.getAttribute('alt');
        const parent = thumb.closest('.product-image');

        mainImage.classList.add('opacity-0');

        setTimeout(() => {
          mainImage.src = newSrc;
          mainImage.alt = newAlt;
          mainImage.onload = () => mainImage.classList.remove('opacity-0');
        }, 200);

        thumbs.forEach((t) => {
          // t.classList.remove('border-2', 'border-primary')
          const p = t.closest('.product-image');

          if (p) {
            p.classList.remove('border-2', 'border-primary');
          }
        });

        // thumb.classList.add('border-2', 'border-primary');
        if (parent) {
          parent.classList.add('border-2', 'border-primary');
        }
      });
    });

    const variantButtons = document.querySelectorAll('.variant-button');
    const priceField = document.getElementById('variant-price');
    const hiddenInput = document.getElementById('selected-variant-id');
    const addToCartBtn = document.getElementById('add-to-cart-btn');
    const addToCartOriginalText = addToCartBtn ? addToCartBtn.textContent.trim() : 'Add to Cart';

    // üîπ NEW: Subscription wrapper reference
    const subscriptionWrapper = document.getElementById('subscription-wrapper');

    // Preselect default variant (first available)
    const defaultButton = document.querySelector('.variant-button[data-default="true"]');
    if (defaultButton) {
      selectVariant(defaultButton);
    }

    variantButtons.forEach((button) => {
      button.addEventListener('click', () => {
        if (button.classList.contains('active')) return;
        selectVariant(button);
      });
    });

    function selectVariant(button) {
      // Clear active on all variant buttons
      variantButtons.forEach((btn) => {
        btn.classList.remove('active', 'border-primary');
        const input = btn.querySelector('input[type="radio"]');
        if (input) input.checked = false;
      });

      // Set active on clicked
      button.classList.add('active', 'border-primary');
      const input = button.querySelector('input[type="radio"]');
      if (input) input.checked = true;

      // Update hidden input for form
      const variantId = button.dataset.variantId;
      if (hiddenInput && variantId) {
        hiddenInput.value = variantId;
      }

      // Update price display
      const variantPrice = button.dataset.variantPrice;
      if (priceField && variantPrice) {
        const formatted = (variantPrice / 100).toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });
        priceField.textContent = formatted;
      }

      const isAvailable = button.dataset.available === 'true';

      // Toggle price out-of-stock styling
      if (priceField) {
        if (isAvailable) {
          priceField.classList.remove('out-of-stock');
        } else {
          priceField.classList.add('out-of-stock');
        }
      }

      // ‚≠êÔ∏è NEW: Toggle subscription widget visibility
      if (subscriptionWrapper) {
        if (isAvailable) {
          subscriptionWrapper.classList.remove('hidden');
        } else {
          subscriptionWrapper.classList.add('hidden');
        }
      }

      // Toggle Add to Cart button state & styles
      if (addToCartBtn) {
        if (isAvailable) {
          addToCartBtn.disabled = false;
          addToCartBtn.textContent = 'Add to cart';

          addToCartBtn.classList.remove(
            'btn--out-of-stock',
            'border',
            'border-primary',
            'text-gray-400',
            'bg-transparent',
            'cursor-not-allowed',
            'opacity-50'
          );
          addToCartBtn.classList.add('btn-mint', 'btn--add-to-cart');
        } else {
          addToCartBtn.disabled = true;
          addToCartBtn.textContent = 'Currently out of stock';

          addToCartBtn.classList.add(
            'btn--out-of-stock',
            'border',
            'border-primary',
            'text-gray-400',
            'bg-transparent',
            'cursor-not-allowed',
            'opacity-50'
          );
          addToCartBtn.classList.remove('btn-mint', 'btn--add-to-cart');
        }
      }
    }
  });
</script>
