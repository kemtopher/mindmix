{% assign current_variant = product.selected_or_first_available_variant %}

<div class='add-to-cart'>
  <form method='post' action='/cart/add' id='add-to-cart-form' class='mt-8'>
    <!-- Onetime purchase option -->
    <input
      type='hidden'
      id='selected-variant-id'
      name='id'
      value='{{ current_variant.id }}'
    >
    <!-- Subscribe option -->
    <input
      type='hidden'
      id='selected-selling-plan'
      name='selling_plan'
      value=''
    >
    <button
      type='button'
      id='add-to-cart-btn'
      class='
        w-full px-8 py-4 text-lg font-bold disabled:opacity-50 disabled:cursor-not-allowed
        {% if product.available %}
          btn btn-mint btn--add-to-cart
        {% else %}
          btn btn--out-of-stock border border-primary text-gray-400 bg-transparent
        {% endif %}
      '
      {% unless product.available %}
        disabled
      {% endunless %}
    >
      {% if product.available %}
        Add to cart
      {% else %}
        Currently out of stock
      {% endif %}
    </button>

    <p id='custom-cart-message' class='cart-message' aria-live='polite'></p>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('add-to-cart-form');
    const btn = document.getElementById('add-to-cart-btn');
    const messageEl = document.getElementById('custom-cart-message');
    if (!form || !btn || !messageEl) return;

    // Subscribe/One time option select (MUST be declared before click handler uses them)
    const subscribeOption = document.getElementById('subscribe-option');
    const onetimeOption = document.getElementById('onetime-option');
    const sellingPlanInput = document.getElementById('selected-selling-plan');

    const subscribeRadio = document.getElementById('subscribe-selector-radio');
    const onetimeRadio = document.getElementById('onetime-selector-radio');

    function setMessage(text, type = 'info') {
      messageEl.textContent = text;
      messageEl.className = 'cart-message mt-4 text-primary cart-message--' + type;
    }

    function getActiveSellingPlanId() {
      return (window.__ACTIVE_SELLING_PLAN_ID__ || '').trim();
    }

    async function getCart() {
      const res = await fetch('/cart.js', { credentials: 'same-origin' });
      if (!res.ok) throw new Error('Cart fetch failed');
      return res.json();
    }

    function findItemInCart(cart, variantId) {
      const idInt = parseInt(variantId, 10);
      return cart.items.find((item) => item.variant_id === idInt);
    }

    // Add to cart POST
    async function addToCart(variantId, quantity = 1) {
      const sellingPlan = sellingPlanInput?.value?.trim();

      const res = await fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Accept: 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify({
          id: variantId,
          quantity,
          ...(sellingPlan ? { selling_plan: sellingPlan } : {}),
        }),
      });

      if (!res.ok) {
        // Shopify returns 422 for inventory issues, etc.
        let errorText = 'Could not add to cart.';
        try {
          const data = await res.json();
          if (data && data.description) {
            errorText = data.description;
          }
        } catch (e) {
          // ignore
        }
        throw new Error(errorText);
      }

      return res.json();
    }

    btn.addEventListener('click', async function () {
      if (btn.disabled) return;

      // Read current variant at click time
      const variantId = form.querySelector('input[name="id"]').value;

      // If user selected subscribe but selling_plan is empty, block add
      const subscribeSelected = subscribeOption?.classList.contains('ring-2');
      const sellingPlan = sellingPlanInput?.value?.trim();
      if (subscribeSelected && !sellingPlan) {
        setMessage('Please select a subscription option that supports subscriptions.', 'error');
        return;
      }

      setMessage('');
      btn.disabled = true;

      try {
        const cart = await getCart();
        const existingItem = findItemInCart(cart, variantId);

        // Only enforce limit on trial product (best handled via Liquid, shown conceptually here)
        const isTrial = window.location.pathname.includes('/products/free-trial-pack');

        if (isTrial && existingItem && existingItem.quantity >= 1) {
          setMessage('Only one trial pack allowed per order', 'warning');
          btn.disabled = false;
          return;
        }

        await addToCart(variantId, 1);
        const updatedCart = await getCart();
        const cartCountEl = document.getElementById('cart-count');
        if (cartCountEl) cartCountEl.innerHTML = updatedCart.item_count;
        setMessage('Added to cart âœ…', 'success');
      } catch (err) {
        setMessage(err.message || 'Sorry, this item is out of stock.', 'error');
      } finally {
        btn.disabled = false;
      }
    });

    function selectPurchaseType(type) {
      const activePlanId = getActiveSellingPlanId();

      if (type === 'subscribe') {
        // UI card state
        subscribeOption?.classList.add('ring-2');
        onetimeOption?.classList.remove('ring-2', 'ring-primary');

        // radio btn
        subscribeRadio?.classList.add('bg-citrus');
        onetimeRadio?.classList.remove('bg-primary');

        // Guard: no selling plan
        if (!activePlanId) {
          setMessage('Subscription is not available for this option.', 'error');
          if (sellingPlanInput) sellingPlanInput.value = '';
          return;
        }

        if (sellingPlanInput) sellingPlanInput.value = String(activePlanId);
      } else {
        // UI card state
        onetimeOption?.classList.add('ring-2', 'ring-primary');
        subscribeOption?.classList.remove('ring-2');

        // radio btn
        onetimeRadio?.classList.add('bg-primary');
        subscribeRadio?.classList.remove('bg-citrus');

        if (sellingPlanInput) sellingPlanInput.value = '';
      }
    }

    subscribeOption?.addEventListener('click', () => selectPurchaseType('subscribe'));
    onetimeOption?.addEventListener('click', () => selectPurchaseType('onetime'));
  });
</script>
