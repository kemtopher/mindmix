<section
  id='shopify-section-main-product'
  class='w-full pt-44 pb-16 flex flex-col md:flex-row items-center justify-center'
>
  <div class='container flex flex-col lg:flex-row justify-between gap-8'>
    <div class='product-gallery w-full h-full lg:max-h-[500px] flex flex-col lg:flex-row gap-4 lg:gap-8 justify-start'>
      <div class='product-images scrollbar-hide overflow-x-scroll overflow-y-hidden w-full lg:max-w-[72px] flex flex-row lg:flex-col gap-4 order-2 lg:order-1 justify-start'>
        {% for media in product.media %}
          {% if media.media_type == 'image' %}
            <div class='product-image relative aspect-square w-[72px] h-[72px] sm:overflow-hidden'>
              <img
                src='{{ media | img_url: '72x72' }}'
                data-full='{{ media | img_url: '960x960' }}'
                alt='{{ media.alt | escape | default: product.title }}'
                class='thumb cursor-pointer w-full object-cover hover:opacity-80'
              >
            </div>
          {% endif %}
        {% endfor %}
      </div>

      <div class='order-1 lg:order-2 text-center overflow-hidden'>
        <img
          id='main-product-image'
          src='{{ product.featured_image | img_url: '960x960' }}'
          alt='{{ product.title }}'
          class='h-full w-full object-cover'
          data-full='{{ product.featured_image | img_url: '960x960' }}'
        >
      </div>
    </div>

    <div class='product-details w-full'>
      <div class='product-info pb-8'>
        <h1 class='text-2xl lg:text-4xl font-bold text-primary mb-4'>{{ product.title | upcase }}</h1>
        <div class='text-sm text-white h-max mb-4 font-light'>{{ product.description }}</div>

        {% assign current_variant = product.selected_or_first_available_variant %}

        <div
          id='variant-price'
          class='text-2xl lg:text-3xl text-primary {% unless current_variant.available %}out-of-stock{% endunless %}'
        >
          {% if current_variant.price == 0 %}
            Free - just pay shipping
          {% else %}
            {{ current_variant.price | money }}
          {% endif %}
        </div>
      </div>

      {% if product.handle != 'free-trial-pack' %}
        <div class='product-variant-select'>
          <p class='text-base text-white font-normal'>Quantity:</p>

          {% assign variant_size = product.variants %}
          {% if variant_size.size > 0 %}
            {% assign current_variant = product.selected_or_first_available_variant %}

            <div class='variant-well flex py-4 gap-4 group flex-wrap'>
              {% for variant in product.variants %}
                {% assign is_default = false %}
                {% assign first_alloc = variant.selling_plan_allocations | first %}
                {% assign first_selling_plan_id = '' %}
                {% assign first_subscribe_price = '' %}

                {% if first_alloc %}
                  {% assign first_selling_plan_id = first_alloc.selling_plan.id %}
                  {% assign first_subscribe_price = first_alloc.price %}
                {% endif %}

                {% if current_variant and variant.id == current_variant.id and variant.available %}
                  {% assign is_default = true %}
                {% endif %}

                <div class='variant-option flex flex-col items-start'>
                  <button
                    class='
                      variant-button relative p-4 border rounded-xl transition-all
                      hover:cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/60 focus-visible:ring-offset-2 focus-visible:ring-offset-black border-gray-700
                      {% if is_default %} active border-primary {% else %} border-gray-700 {% endif %}
                      {% unless variant.available %} opacity-50 cursor-not-allowed {% endunless %}{% if variant.metafields.custom.badges != blank %} best-value hover:border-citrus hover:text-citrus {% else %} hover:border-primary hover:text-primary {% endif %}
                    '
                    data-variant-id='{{ variant.id }}'
                    data-variant-price='{{ variant.price }}'
                    data-variant-unit-price='{{ variant.unit_price }}'
                    data-variant-unit-quantity='{{ variant.unit_price_measurement.quantity_value }}'
                    data-available='{{ variant.available }}'
                    data-default='{% if is_default %}true{% else %}false{% endif %}'
                    data-selling-plan-id='{{ first_selling_plan_id }}'
                    data-subscribe-price='{{ first_subscribe_price }}'
                    data-sticks-per-pack='{% if variant.unit_price_measurement.quantity_value %}{{ variant.unit_price_measurement.quantity_value }}{% else %}30{% endif %}'
                    {% unless variant.available %}
                      disabled
                    {% endunless %}
                  >
                    {% if variant.metafields.custom.badges != blank %}
                      <span
                        class='
                          pointer-events-none absolute -top-2.5 -right-2.5 z-10 whitespace-nowrap rounded-full
                          bg-citrus px-2 py-1 text-[10px] font-extrabold uppercase tracking-wide text-black
                          shadow-lg
                        '
                      >
                        {{ variant.metafields.custom.badges }}
                      </span>
                    {% endif %}

                    <h3 class='font-semibold leading-tight'>{{ variant.title }}</h3>

                    <input
                      type='radio'
                      name='variant'
                      id='variant-{{ variant.id }}'
                      value='{{ variant.id }}'
                      hidden
                    >
                  </button>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% endif %}

      {% render 'da-restock' %}

      <div class='mt-12'>
        <p class='mb-5 text-sm font-semibold uppercase tracking-wider text-gray-400'>Choose Your Option:</p>

        <div class='grid grid-cols-1 gap-5 md:grid-cols-2'>
          <div
            id='subscribe-option'
            role='button'
            tabindex='0'
            data-purchase-type='subscribe'
            class='
              relative cursor-pointer rounded-2xl border-2 border-citrus
              bg-gradient-to-br from-citrus/20 to-citrus/5
              p-6 shadow-xl shadow-citrus/30
              transition-all hover:-translate-y-1 hover:shadow-citrus/50
              focus:outline-none focus-visible:ring-2 focus-visible:ring-citrus/60
            '
          >
            <span
              class='
                pointer-events-none absolute -top-4 -right-2.5 -translate-x-1/2
                rounded-full bg-citrus px-4 py-1
                text-[10px] font-extrabold uppercase tracking-wider text-black shadow-lg
              '
            >
              Most Popular
            </span>

            <div class='mb-4 flex items-start gap-3'>
              <div
                id='subscribe-selector-radio'
                class='relative mt-1 h-5 w-5 rounded-full border-2 border-citrus'
              >
                <!-- <div class='absolute inset-0.5 rounded-full bg-citrus'></div> -->
              </div>
              <div>
                <h3 class='text-xl font-black text-citrus'>Subscribe &amp; Save</h3>
                <p class='mt-1 text-xs font-semibold text-citrus'>Lock in founders pricing</p>
              </div>
            </div>

            <div class='mb-4'>
              <div class='flex items-baseline gap-2'>
                <div id='subscribe-price' class='text-4xl font-black text-white'>$0.00</div>
                <span class='text-base font-semibold text-gray-300'>/mo</span>
              </div>

              <div class='mt-2 flex flex-wrap items-center gap-2'>
                <span
                  class='
                    rounded-md bg-citrus px-3 py-1.5
                    text-xs font-extrabold uppercase tracking-wide text-black shadow
                  '
                >
                  Save $0
                </span>
                <span id='subscribe-per-stick' class='text-sm font-medium text-gray-300'> $0.00 / stick </span>
              </div>
            </div>

            <ul class='space-y-2 text-sm'>
              <li class='flex items-start gap-2 text-white'>
                <span class='mt-1 text-citrus'>âœ“</span>
                <strong class='text-citrus'>Save 20%</strong> on every order
              </li>
              <li class='flex items-start gap-2 text-white'>
                <span class='mt-1 text-citrus'>âœ“</span>
                Free shipping on all subscriptions
              </li>
              <li class='flex items-start gap-2 text-white'>
                <span class='mt-1 text-citrus'>âœ“</span>
                Early access to new flavors
              </li>
              <li class='flex items-start gap-2 text-white'>
                <span class='mt-1 text-citrus'>âœ“</span>
                Cancel anytime
              </li>
            </ul>

            <div class='mt-4 border-t border-citrus/30 pt-4 text-center'>
              <span class='text-base font-black text-citrus'> Save $0 / year </span>
            </div>
          </div>

          <div
            id='onetime-option'
            role='button'
            tabindex='0'
            data-purchase-type='onetime'
            class='
              relative cursor-pointer rounded-2xl border-2 border-gray-700
              p-6 transition-all hover:-translate-y-1 hover:border-primary hover:shadow-lg
              focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/60
            '
          >
            <div class='mb-4 flex items-start gap-3'>
              <div id='onetime-selector-radio' class='mt-1 h-5 w-5 rounded-full border-2 border-primary'></div>
              <div>
                <h3 class='text-xl font-bold text-white'>One-Time Purchase</h3>
                <p class='mt-1 text-xs text-gray-500'>No subscription</p>
              </div>
            </div>

            <div class='mb-4'>
              <div class='flex items-baseline gap-2'>
                <div id='oneTime-price' class='text-4xl font-black text-white'>{{ current_variant.price | money }}</div>
              </div>

              <div class='mt-2 text-sm text-gray-400'>
                <span id='onetime-per-stick'>
                  {{- current_variant.unit_price | money }}
                </span>
                <span>/ stick</span>
              </div>
            </div>

            <ul class='space-y-2 text-sm text-gray-400'>
              <li class='flex items-start gap-2'>
                <span class='mt-1'>âœ“</span>
                Full supply (<span id='onetime-pack-size'>30</span> sticks)
              </li>
              <li class='flex items-start gap-2'>
                <span class='mt-1'>âœ“</span>
                Shipping calculated at checkout
              </li>
              <li class='flex items-start gap-2'>
                <span class='mt-1'>âœ“</span>
                30-day money-back guarantee
              </li>
              <li class='flex items-start gap-2'>
                <span class='mt-1'>âœ“</span>
                No commitment
              </li>
            </ul>
          </div>
        </div>
      </div>

      {% render 'add-to-cart-btn' %}
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // product variant image resetting
    const mainImage = document.getElementById('main-product-image');
    const thumbs = document.querySelectorAll('.thumb');

    thumbs.forEach((thumb) => {
      thumb.addEventListener('click', () => {
        const newSrc = thumb.getAttribute('data-full');
        const newAlt = thumb.getAttribute('alt');
        const parent = thumb.closest('.product-image');

        mainImage.classList.add('opacity-0');

        setTimeout(() => {
          mainImage.onload = () => mainImage.classList.remove('opacity-0');
          mainImage.src = newSrc;
          mainImage.alt = newAlt;

          if (mainImage.complete) mainImage.classList.remove('opacity-0');
        }, 200);

        thumbs.forEach((t) => {
          const p = t.closest('.product-image');
          if (p) p.classList.remove('border-2', 'border-primary');
        });

        if (parent) parent.classList.add('border-2', 'border-primary');
      });
    });

    const variantButtons = document.querySelectorAll('.variant-button');
    const subscribePriceField = document.getElementById('subscribe-price');
    const subscribePerStickField = document.getElementById('subscribe-per-stick');
    const priceField = document.getElementById('variant-price');
    const oneTimePriceField = document.getElementById('oneTime-price');
    const oneTimeUnitPriceField = document.getElementById('onetime-per-stick');
    const oneTimeUnitQuantity = document.getElementById('onetime-pack-size');
    const hiddenInput = document.getElementById('selected-variant-id');
    const addToCartBtn = document.getElementById('add-to-cart-btn');

    // ðŸ”¹ Subscription wrapper reference (if you re-enable the embed later)
    const subscriptionWrapper = document.getElementById('subscription-wrapper');

    // Default purchase type UI (recommended): One-time selected by default
    const subscribeOptionElInit = document.getElementById('subscribe-option');
    const subscribeOptionRadio = subscribeOptionElInit?.querySelector('#subscribe-selector-radio div');
    const onetimeOptionElInit = document.getElementById('onetime-option');
    const onetimeOptionRadio = onetimeOptionElInit?.querySelector('#onetime-selector-radio');
    onetimeOptionElInit?.classList.add('ring-2', 'ring-primary');
    onetimeOptionRadio?.classList.add('bg-primary');
    subscribeOptionElInit?.classList.remove('ring-2');
    subscribeOptionRadio?.classList.remove('bg-citrus');

    // Preselect default variant (first available)
    const defaultButton = document.querySelector('.variant-button[data-default="true"]');
    if (defaultButton) selectVariant(defaultButton);

    variantButtons.forEach((button) => {
      button.addEventListener('click', () => {
        if (button.classList.contains('active')) return;
        selectVariant(button);
      });
    });

    // cents to money helper
    function formatMoneyFromCents(cents) {
      const n = Number(cents || 0) / 100;
      return n.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
    }

    function selectVariant(button) {
      // Clear active on all variant buttons
      variantButtons.forEach((btn) => {
        btn.classList.remove('active', 'border-primary');
        const input = btn.querySelector('input[type="radio"]');
        if (input) input.checked = false;
      });

      // Set active on clicked
      button.classList.add('active', 'border-primary');
      const input = button.querySelector('input[type="radio"]');
      if (input) input.checked = true;

      // Update hidden input for form
      const variantId = button.dataset.variantId;
      if (hiddenInput && variantId) hiddenInput.value = variantId;

      // Catch variant info from button data attrs
      const variantPrice = button.dataset.variantPrice;
      const variantUnitPrice = button.dataset.variantUnitPrice;
      const variantUnitQuantity = button.dataset.variantUnitQuantity;

      const subscribePrice = button.dataset.subscribePrice; // cents (string) or ''
      const sticksPerPack = Number(button.dataset.sticksPerPack || variantUnitQuantity || 0);

      // ---- SUBSCRIPTION: keep active selling plan in sync with selected variant ----
      const sellingPlanIdForVariant = (button.dataset.sellingPlanId || '').trim();
      window.__ACTIVE_SELLING_PLAN_ID__ = sellingPlanIdForVariant;

      const sellingPlanInput = document.getElementById('selected-selling-plan');
      const subscribeOptionEl = document.getElementById('subscribe-option');
      const onetimeOptionEl = document.getElementById('onetime-option');

      const subscribeIsSelected = subscribeOptionEl?.classList.contains('ring-2');

      // If user already selected Subscribe, update the hidden selling_plan input immediately
      if (sellingPlanInput && subscribeIsSelected) {
        sellingPlanInput.value = sellingPlanIdForVariant ? String(sellingPlanIdForVariant) : '';
      }

      // If Subscribe is selected but this variant has no selling plan, force One-time selection
      if (subscribeIsSelected && !sellingPlanIdForVariant) {
        subscribeOptionEl?.classList.remove('ring-2');
        onetimeOptionEl?.classList.add('ring-2', 'ring-primary');
        if (sellingPlanInput) sellingPlanInput.value = '';
      }

      // Update price displays one time
      if (priceField && variantPrice) {
        const formatted = (variantPrice / 100).toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });

        const formattedUnitPrice = (variantUnitPrice / 100).toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });

        const formattedUnitQuantity = Math.floor(Number(variantUnitQuantity || 0));

        priceField.textContent = formatted;
        if (oneTimePriceField) oneTimePriceField.textContent = formatted;
        if (oneTimeUnitPriceField) oneTimeUnitPriceField.textContent = formattedUnitPrice;
        if (oneTimeUnitQuantity) oneTimeUnitQuantity.textContent = formattedUnitQuantity;
      }

      // hide subscription plan if not available
      if (subscribeOptionEl) {
        if (!sellingPlanIdForVariant) {
          subscribeOptionEl.classList.add('opacity-50', 'pointer-events-none');
        } else {
          subscribeOptionEl.classList.remove('opacity-50', 'pointer-events-none');
        }
      }

      // Update price displays subscription
      if (subscribePriceField && subscribePerStickField) {
        if (subscribePrice) {
          // main subscribe price
          subscribePriceField.textContent = formatMoneyFromCents(subscribePrice);

          // per-stick price
          const sticks = sticksPerPack > 0 ? sticksPerPack : 1;
          const perStickCents = Math.round(Number(subscribePrice) / sticks);
          subscribePerStickField.textContent = `${formatMoneyFromCents(perStickCents)} / stick`;
        } else {
          // variant has no subscription allocation
          subscribePriceField.textContent = 'â€”';
          subscribePerStickField.textContent = 'â€”';
        }
      }

      const isAvailable = button.dataset.available === 'true';

      // Toggle price out-of-stock styling
      if (priceField) {
        if (isAvailable) priceField.classList.remove('out-of-stock');
        else priceField.classList.add('out-of-stock');
      }

      // Toggle subscription widget visibility (if you re-enable it later)
      if (subscriptionWrapper) {
        if (isAvailable) subscriptionWrapper.classList.remove('hidden');
        else subscriptionWrapper.classList.add('hidden');
      }

      // Toggle Add to Cart button state & styles
      if (addToCartBtn) {
        if (isAvailable) {
          addToCartBtn.disabled = false;
          addToCartBtn.textContent = 'Add to cart';

          addToCartBtn.classList.remove(
            'btn--out-of-stock',
            'border',
            'border-primary',
            'text-gray-400',
            'bg-transparent',
            'cursor-not-allowed',
            'opacity-50'
          );
          addToCartBtn.classList.add('btn-mint', 'btn--add-to-cart');
        } else {
          addToCartBtn.disabled = true;
          addToCartBtn.textContent = 'Currently out of stock';

          addToCartBtn.classList.add(
            'btn--out-of-stock',
            'border',
            'border-primary',
            'text-gray-400',
            'bg-transparent',
            'cursor-not-allowed',
            'opacity-50'
          );
          addToCartBtn.classList.remove('btn-mint', 'btn--add-to-cart');
        }
      }
    }
  });
</script>
