{% comment %}
  MindMix Theme Layout
  - Handles base HTML structure
  - Includes necessary meta tags and SEO
  - Manages loading states and animations
{% endcomment %}

<!doctype html>
<html lang='en'>
  <head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>{{ page_title | escape }}</title>
    <meta name='description' content='{{ page_description | escape }}'>

    <link rel='preconnect' href='https://fonts.googleapis.com'>
    <link rel='preconnect' href='https://fonts.gstatic.com' crossorigin>
    <link
      href='https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700&display=swap'
      rel='stylesheet'
    >

    {{ 'style.css' | asset_url | stylesheet_tag }}

    {{ 'theme.css' | asset_url | stylesheet_tag }}

    {{ content_for_header }}

    {% if settings.favicon != blank %}
      <link
        rel='icon'
        type='image/png'
        href='{{ settings.favicon | image_url: width: 32 }}'
      >
    {% endif %}

    {% if settings.apple_touch_icon != blank %}
      <link
        rel='apple-touch-icon'
        href='{{ settings.apple_touch_icon | image_url: width: 180 }}'
      >
    {% endif %}
  </head>
  <body class='bg-dark text-light'>
    {% section 'header' %}

    <main role='main' id='main-content' tabindex='-1'>
      {{ content_for_layout }}

      <section class='section-padding bg-darker relative'>
        <div class='container-custom relative max-w-4xl mx-auto'>
          {% section 'global-faq' %}
        </div>
      </section>
    </main>

    {% section 'newsletter-signup' %}
    {% section 'footer' %}

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // Initialize animations
        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add('is-visible');
              }
            });
          },
          { threshold: 0.1 }
        );

        document.querySelectorAll('.fade-in').forEach((el) => observer.observe(el));
      });
    </script>

    <!-- MindMix Upsell Redirect Script - FIXED VERSION -->
    <script>
    (function() {
      console.log('[MINDMIX] Cart redirect script loaded (FIXED)');
      
      // Configuration
      const UPSELL_URL = '/pages/upsells';
      
      // Don't redirect if we're already on upsell page or checkout
      if (window.location.pathname.includes('/pages/upsells') || 
          window.location.pathname.includes('/checkout') ||
          window.location.pathname.includes('/cart')) {
        console.log('[MINDMIX] On upsell/checkout/cart page, skipping redirect setup');
        return;
      }
      
      // Method 1: Intercept Shopify's Cart API calls (AJAX add-to-cart)
      const originalFetch = window.fetch;
      window.fetch = function(...args) {
        const url = args[0];
        
        // Check if this is a cart add request
        if (typeof url === 'string' && url.includes('/cart/add')) {
          console.log('[MINDMIX] Intercepted cart add request');
          
          // Call original fetch
          return originalFetch.apply(this, args).then(function(response) {
            // Clone response so we can still return it
            const clonedResponse = response.clone();
            
            // If successful, redirect to upsell page
            if (response.ok) {
              console.log('[MINDMIX] Cart add successful, redirecting to upsell page');
              
              // Small delay to ensure cart is updated
              setTimeout(function() {
                window.location.href = UPSELL_URL;
              }, 100);
            }
            
            return clonedResponse;
          });
        }
        
        // Not a cart add request, proceed normally
        return originalFetch.apply(this, args);
      };
      
      // Method 2: Intercept form submissions (traditional add-to-cart forms)
      document.addEventListener('submit', function(e) {
        const form = e.target;
        
        // Check if this is an add-to-cart form
        if (form.action && form.action.includes('/cart/add')) {
          console.log('[MINDMIX] Intercepted cart form submission');
          
          // Prevent default form submission
          e.preventDefault();
          
          // Get form data
          const formData = new FormData(form);
          
          // Submit via AJAX
          fetch('/cart/add.js', {
            method: 'POST',
            body: formData
          })
          .then(function(response) {
            if (response.ok) {
              console.log('[MINDMIX] Cart add successful, redirecting to upsell page');
              window.location.href = UPSELL_URL;
            } else {
              console.error('[MINDMIX] Cart add failed');
              alert('Failed to add item to cart. Please try again.');
            }
          })
          .catch(function(error) {
            console.error('[MINDMIX] Cart add error:', error);
            alert('Failed to add item to cart. Please try again.');
          });
        }
      });
      
      console.log('[MINDMIX] Cart redirect handlers initialized');
    })();
    </script>
    <!-- End MindMix Upsell Redirect Script -->

  </body>
</html>