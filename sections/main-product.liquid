<!-- Product Section -->
<section id='shopify-section-main-product'>
  <div class='container mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8'>
    <!-- PRODUCT GALLERY / CAROUSEL -->
    <div class='product-gallery'>
      <div id='carousel' class='relative overflow-hidden rounded'>
        <div id='carousel-track' class='whitespace-nowrap transition-transform duration-300 ease-out'>
          {% assign image_index = 0 %}
          {% for media in product.media %}
            {% if media.media_type == 'image' %}
              <div
                class='inline-block align-top w-full'
                data-media-id='{{ media.id }}'
                data-index='{{ image_index }}'
              >
                <img
                  src='{{ media | img_url: "master" }}'
                  alt='{{ media.alt | escape | default: product.title }}'
                  class='w-full max-h-[400px] lg:max-h-[700px] object-cover'
                  loading='{% if forloop.index > 1 %}lazy{% else %}eager{% endif %}'
                >
              </div>
              {% assign image_index = image_index | plus: 1 %}
            {% endif %}
          {% endfor %}
        </div>

        <!-- Controls -->
        <button
          id='prev-btn'
          type='button'
          aria-label='Previous image'
          class='absolute left-2 top-1/2 -translate-y-1/2 bg-black/40 text-white px-3 py-2 rounded hover:bg-black/60'
        >
          ‹
        </button>
        <button
          id='next-btn'
          type='button'
          aria-label='Next image'
          class='absolute right-2 top-1/2 -translate-y-1/2 bg-black/40 text-white px-3 py-2 rounded hover:bg-black/60'
        >
          ›
        </button>
      </div>

      <!-- Thumbnails -->
      <div id='thumbs' class='mt-3 grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 gap-2'>
        {% assign thumb_index = 0 %}
        {% for media in product.media %}
          {% if media.media_type == 'image' %}
            <button
              type='button'
              class='thumb border border-transparent rounded overflow-hidden focus:outline-none focus:ring-2 focus:ring-primary'
              data-index='{{ thumb_index }}'
              aria-label='Go to image {{ thumb_index | plus: 1 }}'
            >
              <img
                src='{{ media | img_url: "200x200" }}'
                alt='{{ media.alt | escape | default: product.title }}'
                class='w-full h-full object-cover'
              >
            </button>
            {% assign thumb_index = thumb_index | plus: 1 %}
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <!-- PRODUCT DETAILS -->
    <div class='product-details pb-26 border-b-white'>
      <h1 class='text-4xl font-bold text-primary mb-4'>{{ product.title }}</h1>
      <div class='text-base text-white h-max mb-12'>{{ product.description }}</div>

      {% assign initial_variant = product.selected_or_first_available_variant %}
      <div id='variant-price' class='text-3xl font-bold text-white text-primary'>
        {{ initial_variant.price | money }}
      </div>

      <!-- (optional) variant UI you already had is below; leave commented or re-enable -->
      <!-- ... your accordion or radios ... -->

      <div class='add-to-cart mt-8'>
        <form method='post' action='/cart/add' id='add-to-cart-form' class='mt-4'>
          <input type='hidden' name='id' id='selected-variant-id' value='{{ initial_variant.id }}'>
          <button
            type='submit'
            id='add-to-cart-btn'
            class='bg-primary text-white font-semibold py-4 px-8 rounded text-xl transition hover:bg-opacity-90 disabled:hover:bg-primary disabled:opacity-50 disabled:cursor-not-allowed'
          >
            Add To Cart
          </button>
        </form>
      </div>

      {% if product.handle == 'try-it-free' %}
        {% if customer %}
          {% if customer.tags contains 'has_trial' %}
            <p class='text-red-600 font-semibold mt-4'>You've already claimed your free trial.</p>
          {% else %}
            <!-- Already using the same form above; button text can be swapped if desired -->
          {% endif %}
        {% else %}
          <a
            href='/account/login?return_url={{ product.url | url_encode }}'
            class='btn-add-to-cart inline-block mt-4 underline'
          >
            Log in to claim your free trial
          </a>
        {% endif %}
      {% endif %}
    </div>
  </div>
</section>

<script>
  // === PRODUCT / VARIANT DATA ===
  const PRODUCT = JSON.parse(`{{ product | json | escape }}`);
  const VARIANTS_BY_ID = {};
  PRODUCT.variants.forEach((v) => (VARIANTS_BY_ID[String(v.id)] = v));

  // === CAROUSEL STATE ===
  const track = document.getElementById('carousel-track');
  const thumbs = document.querySelectorAll('#thumbs .thumb');
  const itemCount = track ? track.children.length : 0;
  const priceEl = document.getElementById('variant-price');
  const hiddenInput = document.getElementById('selected-variant-id');
  const addToCartBtn = document.getElementById('add-to-cart-btn');

  let currentIndex = 0;
  let isDragging = false;
  let startX = 0;
  let currentTranslateX = 0;

  function goTo(index) {
    if (!track) return;
    currentIndex = Math.max(0, Math.min(itemCount - 1, index));
    const offset = -currentIndex * track.clientWidth;
    track.style.transform = `translateX(${offset}px)`;
    // Mark selected thumb
    thumbs.forEach((t, i) => t.classList.toggle('ring-2', i === currentIndex));
  }

  // Resize handler to keep slide aligned
  window.addEventListener('resize', () => goTo(currentIndex));

  // Controls
  document.getElementById('prev-btn')?.addEventListener('click', () => goTo(currentIndex - 1));
  document.getElementById('next-btn')?.addEventListener('click', () => goTo(currentIndex + 1));

  // Thumbs
  thumbs.forEach((btn) => {
    btn.addEventListener('click', () => goTo(parseInt(btn.dataset.index, 10)));
  });

  // Keyboard
  track?.setAttribute('tabindex', '0');
  track?.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') goTo(currentIndex - 1);
    if (e.key === 'ArrowRight') goTo(currentIndex + 1);
  });

  // Basic touch swipe
  track?.addEventListener('pointerdown', (e) => {
    isDragging = true;
    startX = e.clientX;
    currentTranslateX = -currentIndex * track.clientWidth;
    track.setPointerCapture(e.pointerId);
  });
  track?.addEventListener('pointermove', (e) => {
    if (!isDragging) return;
    const delta = e.clientX - startX;
    track.style.transform = `translateX(${currentTranslateX + delta}px)`;
  });
  track?.addEventListener('pointerup', (e) => {
    if (!isDragging) return;
    isDragging = false;
    const delta = e.clientX - startX;
    const threshold = track.clientWidth * 0.15;
    if (delta > threshold) goTo(currentIndex - 1);
    else if (delta < -threshold) goTo(currentIndex + 1);
    else goTo(currentIndex);
  });

  // Jump to a variant's featured image (if present)
  function jumpToVariantMedia(variant) {
    if (!variant || !variant.featured_media) return;
    const mediaId = String(variant.featured_media.id);
    const slideEls = Array.from(track.children);
    const idx = slideEls.findIndex((el) => String(el.dataset.mediaId) === mediaId);
    if (idx >= 0) goTo(idx);
  }

  // === VARIANT UI HOOKS ===
  // If you keep your custom accordion/radio UI, make sure it calls this function:
  window.handleVariantClick = function (event, variantId) {
    // your existing logic...
    const wrapper = event.currentTarget;
    const radio = wrapper.querySelector('input[type="radio"]');
    const content = wrapper.querySelector('.variant-content');
    const indicator = wrapper.querySelector('[data-variant-radio]');

    const allWrappers = document.querySelectorAll('.variant-wrapper');
    allWrappers.forEach((variant) => {
      const r = variant.querySelector('input[type="radio"]');
      const c = variant.querySelector('.variant-content');
      const i = variant.querySelector('[data-variant-radio]');
      r.checked = false;
      c.style.maxHeight = null;
      c.style.display = 'none';
      i.classList.remove('bg-[#00E5A0]', 'border-[#00E5A0]');
      i.classList.add('bg-white', 'border-white');
    });

    // Select
    radio.checked = true;
    content.style.display = 'block';
    content.style.maxHeight = content.scrollHeight + 'px';
    indicator.classList.remove('bg-white', 'border-white');
    indicator.classList.add('bg-[#00E5A0]', 'border-[#00E5A0]');

    // Update hidden input + price + carousel
    if (hiddenInput) hiddenInput.value = variantId;
    const v = VARIANTS_BY_ID[String(variantId)];
    if (priceEl && v) priceEl.textContent = v.price ? Shopify.formatMoney(v.price) : priceEl.textContent;
    if (addToCartBtn) addToCartBtn.disabled = false;
    jumpToVariantMedia(v);
  };

  // If you’re not using the accordion, you can still programmatically select a variant elsewhere:
  window.selectVariantById = function (variantId) {
    if (hiddenInput) hiddenInput.value = variantId;
    const v = VARIANTS_BY_ID[String(variantId)];
    if (priceEl && v) priceEl.textContent = v.price ? Shopify.formatMoney(v.price) : priceEl.textContent;
    if (addToCartBtn) addToCartBtn.disabled = false;
    jumpToVariantMedia(v);
  };

  // Init
  goTo(0);
</script>

{% schema %}
{
  "name": "Main Product",
  "settings": [],
  "presets": [{ "name": "Main Product" }]
}
{% endschema %}
