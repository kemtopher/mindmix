<section
  id='shopify-section-main-product'
  class='w-full pt-44 pb-16 flex flex-col md:flex-row items-center justify-center'
>
  <div class='container flex flex-col lg:flex-row justify-between gap-8'>
    <div class='product-gallery w-full h-full lg:max-h-[500px] flex flex-col lg:flex-row gap-4 lg:gap-8 justify-start'>
      <!--
        {%- assign image_media = product.media | where: 'media_type', 'image' -%}
        {% if image_media.size > 0 %}
      -->
      <div class='product-images scrollbar-hide overflow-x-scroll overflow-y-hidden w-full lg:max-w-[72px] flex flex-row lg:flex-col gap-4 order-2 lg:order-1 justify-start'>
        {% for media in product.media %}
          {% if media.media_type == 'image' %}
            <div class='product-image relative aspect-square w-[72px] h-[72px] sm:overflow-hidden'>
              <img
                src='{{ media | img_url: '72x72' }}'
                data-full='{{ media | img_url: '960x960' }}'
                alt='{{ media.alt | escape | default: product.title }}'
                class='thumb cursor-pointer w-full object-cover hover:opacity-80'
              >
            </div>
          {% endif %}
        {% endfor %}
      </div>
      <!-- {% endif %} -->

      <div class='order-1 lg:order-2 text-center overflow-hidden'>
        <img
          id='main-product-image'
          src='{{ product.featured_image | img_url: '960x960' }}'
          alt='{{ product.title }}'
          class='h-full w-full object-cover'
          data-full='{{ product.featured_image | img_url: '960x960' }}'
        >
      </div>
    </div>

    <div class='product-details w-full'>
      <!-- product info block -->
      <div class='product-info pb-8'>
        <h1 class='text-2xl lg:text-4xl font-bold text-primary mb-4'>{{ product.title | upcase }}</h1>
        <div class='text-sm text-white h-max mb-4 font-light'>{{ product.description }}</div>

        {% assign current_variant = product.selected_or_first_available_variant %}

        <div
          id='variant-price'
          class='text-2xl lg:text-3xl text-primary {% unless current_variant.available %}out-of-stock{% endunless %}'
        >
          {% if current_variant.price == 0 %}
            Free - just pay shipping
          {% else %}
            {{ current_variant.price | money }}
          {% endif %}
        </div>
      </div>

      {% if product.handle != 'free-trial-pack' %}
        <div class='product-variant-select'>
          <p class='text-base text-white font-normal'>Quantity:</p>

          {% assign variant_size = product.variants %}
          {% if variant_size.size > 0 %}
            {% assign current_variant = product.selected_or_first_available_variant %}

            <div class='variant-well flex py-4 gap-4 group flex-wrap'>
              {% for variant in product.variants %}
                {% assign is_default = false %}
                {% if current_variant and variant.id == current_variant.id and variant.available %}
                  {% assign is_default = true %}
                {% endif %}
                <div class='variant-option flex flex-col items-start'>
                  <button
                    class='
                      variant-button relative p-4 border rounded-xl transition-all
                      hover:cursor-pointer hover:border-primary hover:text-primary
                      focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/60 focus-visible:ring-offset-2 focus-visible:ring-offset-black
                      {% if is_default %} active border-primary {% else %} border-gray-700 {% endif %}
                      {% unless variant.available %} opacity-50 cursor-not-allowed {% endunless %}
                    '
                    data-variant-id='{{ variant.id }}'
                    data-variant-price='{{ variant.price }}'
                    data-variant-unit-price='{{ variant.unit_price }}'
                    data-variant-unit-quantity='{{ variant.unit_price_measurement.quantity_value }}'
                    data-available='{{ variant.available }}'
                    data-default='{% if is_default %}true{% else %}false{% endif %}'
                    onclick='handleVariantClick(event, "{{ variant.id }}", "{{ variant.price | json }}")'
                    {% unless variant.available %}
                      disabled
                    {% endunless %}
                  >
                    {% if variant.metafields.custom.badges != blank %}
                      <span
                        class='
                          pointer-events-none absolute -top-2.5 -right-2.5 z-10 whitespace-nowrap rounded-full
                          bg-[#D4AF37] px-2 py-1 text-[10px] font-extrabold uppercase tracking-wide text-black
                          shadow-lg
                        '
                      >
                        {{ variant.metafields.custom.badges }}
                      </span>
                    {% endif %}

                    <h3 class='font-semibold leading-tight'>{{ variant.title }}</h3>

                    <input
                      type='radio'
                      name='variant'
                      id='variant-{{ variant.id }}'
                      value='{{ variant.id }}'
                      hidden
                    >
                  </button>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% endif %}

      {% render 'da-restock' %}

      <!--
        <div
          id='subscription-wrapper'
          class='mt-4 {% unless current_variant.available %}hidden{% endunless %}'
        >
          <div class='subscriptions_app_embed_block mt-4'></div>
        </div>
      -->

      <div class='mt-12'>
        <p class='mb-5 text-sm font-semibold uppercase tracking-wider text-gray-400'>Choose Your Option:</p>

        <div class='grid grid-cols-1 gap-5 md:grid-cols-2'>
          <!-- ================= SUBSCRIBE & SAVE ================= -->
          <div
            id='subscribe-option'
            role='button'
            tabindex='0'
            data-purchase-type='subscribe'
            class='
              relative cursor-pointer rounded-2xl border-2 border-[#D4AF37]
              bg-gradient-to-br from-[#D4AF37]/20 to-[#D4AF37]/5
              p-6 shadow-xl shadow-[#D4AF37]/30
              transition-all hover:-translate-y-1 hover:shadow-[#D4AF37]/50
              focus:outline-none focus-visible:ring-2 focus-visible:ring-[#D4AF37]/60
            '
          >
            <!-- Badge -->
            <span
              class='
                pointer-events-none absolute -top-4 -right-2.5 -translate-x-1/2
                rounded-full bg-[#D4AF37] px-4 py-1
                text-[10px] font-extrabold uppercase tracking-wider text-black shadow-lg
              '
            >
              Most Popular
            </span>

            <!-- Header -->
            <div class='mb-4 flex items-start gap-3'>
              <div class='relative mt-1 h-5 w-5 rounded-full border-2 border-[#D4AF37]'>
                <div class='absolute inset-0.5 rounded-full bg-[#D4AF37]'></div>
              </div>
              <div>
                <h3 class='text-xl font-black text-[#D4AF37]'>Subscribe &amp; Save</h3>
                <p class='mt-1 text-xs font-semibold text-[#D4AF37]'>Lock in founders pricing</p>
              </div>
            </div>

            <!-- Pricing -->
            <div class='mb-4'>
              <div class='flex items-baseline gap-2'>
                <div id='subscribe-price' class='text-4xl font-black text-white'>$0.00</div>
                <span class='text-base font-semibold text-gray-300'>/mo</span>
              </div>

              <div class='mt-2 flex flex-wrap items-center gap-2'>
                <span
                  class='
                    rounded-md bg-[#D4AF37] px-3 py-1.5
                    text-xs font-extrabold uppercase tracking-wide text-black shadow
                  '
                >
                  Save $0
                </span>
                <span id='subscribe-per-stick' class='text-sm font-medium text-gray-300'> $0.00 / stick </span>
              </div>
            </div>

            <!-- Features -->
            <ul class='space-y-2 text-sm'>
              <li class='flex items-start gap-2 text-white'>
                <span class='mt-1 text-[#D4AF37]'>‚úì</span>
                <strong class='text-[#D4AF37]'>Save 20%</strong> on every order
              </li>
              <li class='flex items-start gap-2 text-white'>
                <span class='mt-1 text-[#D4AF37]'>‚úì</span>
                Free shipping on all subscriptions
              </li>
              <li class='flex items-start gap-2 text-white'>
                <span class='mt-1 text-[#D4AF37]'>‚úì</span>
                Early access to new flavors
              </li>
              <li class='flex items-start gap-2 text-white'>
                <span class='mt-1 text-[#D4AF37]'>‚úì</span>
                Cancel anytime
              </li>
            </ul>

            <!-- Bottom Callout -->
            <div class='mt-4 border-t border-[#D4AF37]/30 pt-4 text-center'>
              <span class='text-base font-black text-[#D4AF37]'> Save $0 / year </span>
            </div>
          </div>

          <!-- ================= ONE TIME PURCHASE ================= -->
          <div
            id='onetime-option'
            role='button'
            tabindex='0'
            data-purchase-type='onetime'
            class='
              relative cursor-pointer rounded-2xl border-2 border-gray-700
              p-6 transition-all hover:-translate-y-1 hover:border-primary hover:shadow-lg
              focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/60
            '
          >
            <!-- Header -->
            <div class='mb-4 flex items-start gap-3'>
              <div class='mt-1 h-5 w-5 rounded-full border-2 border-gray-500'></div>
              <div>
                <h3 class='text-xl font-bold text-white'>One-Time Purchase</h3>
                <p class='mt-1 text-xs text-gray-500'>No subscription</p>
              </div>
            </div>

            <!-- Pricing -->
            <div class='mb-4'>
              <div class='flex items-baseline gap-2'>
                <div id='oneTime-price' class='text-4xl font-black text-white'>{{ current_variant.price | money }}</div>
              </div>

              <div class='mt-2 text-sm text-gray-400'>
                <span id='onetime-per-stick'>
                  {{- current_variant.unit_price | money }}
                </span>
                <span>/ stick</span>
              </div>
            </div>

            <!-- Features -->
            <ul class='space-y-2 text-sm text-gray-400'>
              <li class='flex items-start gap-2'>
                <span class='mt-1'>‚úì</span>
                Full supply (<span id='onetime-pack-size'>30</span> sticks)
              </li>
              <li class='flex items-start gap-2'>
                <span class='mt-1'>‚úì</span>
                Shipping calculated at checkout
              </li>
              <li class='flex items-start gap-2'>
                <span class='mt-1'>‚úì</span>
                30-day money-back guarantee
              </li>
              <li class='flex items-start gap-2'>
                <span class='mt-1'>‚úì</span>
                No commitment
              </li>
            </ul>
          </div>
        </div>
      </div>

      {% render 'add-to-cart-btn' %}

      <!--
        {% unless product.handle == 'free-trial-pack' %}
          {% render 'free-trial-btn' %}
        {% endunless %}
      -->
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // product variant image resetting
    const mainImage = document.getElementById('main-product-image');
    const thumbs = document.querySelectorAll('.thumb');

    thumbs.forEach((thumb) => {
      thumb.addEventListener('click', () => {
        const newSrc = thumb.getAttribute('data-full');
        const newAlt = thumb.getAttribute('alt');
        const parent = thumb.closest('.product-image');

        mainImage.classList.add('opacity-0');

        setTimeout(() => {
          mainImage.onload = () => mainImage.classList.remove('opacity-0');
          mainImage.src = newSrc;
          mainImage.alt = newAlt;

          if (mainImage.complete) mainImage.classList.remove('opacity-0');
        }, 200);

        thumbs.forEach((t) => {
          // t.classList.remove('border-2', 'border-primary')
          const p = t.closest('.product-image');

          if (p) {
            p.classList.remove('border-2', 'border-primary');
          }
        });

        // thumb.classList.add('border-2', 'border-primary');
        if (parent) {
          parent.classList.add('border-2', 'border-primary');
        }
      });
    });

    const variantButtons = document.querySelectorAll('.variant-button');
    const priceField = document.getElementById('variant-price');
    const oneTimePriceField = document.getElementById('oneTime-price');
    const oneTimeUnitPriceField = document.getElementById('onetime-per-stick');
    const oneTimeUnitQuantity = document.getElementById('onetime-pack-size');
    const hiddenInput = document.getElementById('selected-variant-id');
    const addToCartBtn = document.getElementById('add-to-cart-btn');
    const addToCartOriginalText = addToCartBtn ? addToCartBtn.textContent.trim() : 'Add to Cart';

    // üîπ NEW: Subscription wrapper reference
    const subscriptionWrapper = document.getElementById('subscription-wrapper');

    // Preselect default variant (first available)
    const defaultButton = document.querySelector('.variant-button[data-default="true"]');
    if (defaultButton) {
      selectVariant(defaultButton);
    }

    variantButtons.forEach((button) => {
      button.addEventListener('click', () => {
        if (button.classList.contains('active')) return;
        selectVariant(button);
      });
    });

    function selectVariant(button) {
      // Clear active on all variant buttons
      variantButtons.forEach((btn) => {
        btn.classList.remove('active', 'border-primary');
        const input = btn.querySelector('input[type="radio"]');
        if (input) input.checked = false;
      });

      // Set active on clicked
      button.classList.add('active', 'border-primary');
      const input = button.querySelector('input[type="radio"]');
      if (input) input.checked = true;

      // Update hidden input for form
      const variantId = button.dataset.variantId;
      if (hiddenInput && variantId) {
        hiddenInput.value = variantId;
      }

      // Catch variant info from buton data attr
      const variantPrice = button.dataset.variantPrice;
      const variantUnitPrice = button.dataset.variantUnitPrice;
      const variantUnitQuantity = button.dataset.variantUnitQuantity;

      // Update price displays
      if (priceField && variantPrice) {
        const formatted = (variantPrice / 100).toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });
        const formattedUnitPrice = (variantUnitPrice / 100).toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
        });
        const formattedUnitQuantity = Math.floor(variantUnitQuantity);

        priceField.textContent = formatted;
        oneTimePriceField.textContent = formatted;
        oneTimeUnitPriceField.textContent = formattedUnitPrice;
        oneTimeUnitQuantity.textContent = formattedUnitQuantity;
      }

      const isAvailable = button.dataset.available === 'true';

      // Toggle price out-of-stock styling
      if (priceField) {
        if (isAvailable) {
          priceField.classList.remove('out-of-stock');
        } else {
          priceField.classList.add('out-of-stock');
        }
      }

      // ‚≠êÔ∏è NEW: Toggle subscription widget visibility
      if (subscriptionWrapper) {
        if (isAvailable) {
          subscriptionWrapper.classList.remove('hidden');
        } else {
          subscriptionWrapper.classList.add('hidden');
        }
      }

      // Toggle Add to Cart button state & styles
      if (addToCartBtn) {
        if (isAvailable) {
          addToCartBtn.disabled = false;
          addToCartBtn.textContent = 'Add to cart';

          addToCartBtn.classList.remove(
            'btn--out-of-stock',
            'border',
            'border-primary',
            'text-gray-400',
            'bg-transparent',
            'cursor-not-allowed',
            'opacity-50'
          );
          addToCartBtn.classList.add('btn-mint', 'btn--add-to-cart');
        } else {
          addToCartBtn.disabled = true;
          addToCartBtn.textContent = 'Currently out of stock';

          addToCartBtn.classList.add(
            'btn--out-of-stock',
            'border',
            'border-primary',
            'text-gray-400',
            'bg-transparent',
            'cursor-not-allowed',
            'opacity-50'
          );
          addToCartBtn.classList.remove('btn-mint', 'btn--add-to-cart');
        }
      }
    }
  });
</script>
