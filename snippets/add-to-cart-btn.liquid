{% assign current_variant = product.selected_or_first_available_variant %}

<div class='add-to-cart'>
  <form method='post' action='/cart/add' id='add-to-cart-form' class='mt-8'>
    <input
      type='hidden'
      id='selected-variant-id'
      name='id'
      value='{{ current_variant.id }}'
    >
    <!-- removed from button:  hover:transform hover:scale-105 transition-transform -->
    <button
      type='button'
      id='add-to-cart-btn'
      class='
        w-full px-8 py-4 text-lg font-bold disabled:opacity-50 disabled:cursor-not-allowed
        {% if product.available %}
          btn btn-mint btn--add-to-cart
        {% else %}
          btn btn--out-of-stock border border-primary text-gray-400 bg-transparent
        {% endif %}
      '
      {% unless product.available %}
        disabled
      {% endunless %}
    >
      {% if product.available %}
        Add to cart
      {% else %}
        Currently out of stock
      {% endif %}
    </button>

    <p id='custom-cart-message' class='cart-message' aria-live='polite'></p>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('add-to-cart-form');
    const btn = document.getElementById('add-to-cart-btn');
    const messageEl = document.getElementById('custom-cart-message');
    if (!form || !btn || !messageEl) return;

    // const variantId = form.querySelector('input[name="id"]').value;

    // Change this if you want to allow more than 1
    const MAX_QTY_PER_VARIANT = 1;

    function setMessage(text, type = 'info') {
      messageEl.textContent = text;
      messageEl.className = 'cart-message mt-4 text-primary cart-message--' + type;
    }

    async function getCart() {
      const res = await fetch('/cart.js', { credentials: 'same-origin' });
      if (!res.ok) throw new Error('Cart fetch failed');
      return res.json();
    }

    function findItemInCart(cart, variantId) {
      const idInt = parseInt(variantId, 10);
      return cart.items.find((item) => item.variant_id === idInt);
    }

    async function addToCart(variantId, quantity = 1) {
      const res = await fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Accept: 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify({ id: variantId, quantity }),
      });

      if (!res.ok) {
        // Shopify returns 422 for inventory issues, etc.
        let errorText = 'Could not add to cart.';
        try {
          const data = await res.json();
          if (data && data.description) {
            errorText = data.description;
          }
        } catch (e) {
          // ignore
        }
        throw new Error(errorText);
      }

      return res.json();
    }

    btn.addEventListener('click', async function () {
      if (btn.disabled) return;

      // ✅ Read current variant at click time
      const variantId = form.querySelector('input[name="id"]').value;

      setMessage('');
      btn.disabled = true;

      try {
        const cart = await getCart();
        const existingItem = findItemInCart(cart, variantId);

        // ✅ Only enforce limit on trial product (best handled via Liquid, shown conceptually here)
        const isTrial = window.location.pathname.includes('/products/free-trial-pack');

        if (isTrial && existingItem && existingItem.quantity >= 1) {
          setMessage('Only one trial pack allowed per order', 'warning');
          btn.disabled = false;
          return;
        }
        // if (MAX_QTY_PER_VARIANT && existingItem && existingItem.quantity >= MAX_QTY_PER_VARIANT) {
        //   setMessage('Only one trial pack allowed per order', 'warning');
        //   btn.disabled = false;
        //   return;
        // }

        await addToCart(variantId, 1);
        setMessage('Added to cart ✅', 'success');
      } catch (err) {
        setMessage(err.message || 'Sorry, this item is out of stock.', 'error');
      } finally {
        btn.disabled = false;
      }
    });
  });
</script>
